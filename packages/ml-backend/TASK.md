# Задача: Создание серверного сервиса обучения (`ml-backend`)

Этот документ описывает шаги по созданию серверного Node.js приложения, единственной задачей которого является обучение нейронной сети.

Сервис будет работать по следующему принципу:
1.  Подписывается на канал Ably, ожидая данные для обучения (опыт).
2.  Полученные данные складывает в буфер воспроизведения (`ReplayBuffer`).
3.  Когда накапливается достаточно данных, запускает процесс обучения модели.
4.  После каждого цикла обучения, публикует обновленные веса модели в канал Ably и сохраняет их локально на диск.

---

### Шаг 1: Настройка серверного окружения

Адаптация проекта для работы в среде Node.js.

1.  **Изменить `package.json`**:
    *   Удалить все зависимости, связанные с фронтендом (`vite`, `react`, `tailwindcss` и т.д.).
    *   Добавить зависимости, необходимые для сервера: `@tensorflow/tfjs-node`, `ably`, `ts-node`, `nodemon`.
    *   Обновить секцию `"scripts"` для запуска и сборки Node.js приложения.

2.  **Обновить `tsconfig.json`**:
    *   Настроить `compilerOptions` для компиляции под Node.js (изменить `module`, `moduleResolution`, `target`, `lib`).

3.  **Удалить лишние файлы**:
    *   Удалить конфигурацию Vite (`config.vite.ts`) и HTML-файлы (`appo.html`).

---

### Шаг 2: Архитектура коммуникации

Определение минимально необходимых каналов Ably.

1.  **Определить каналы**:
    *   `ppo:experience:submit`: Канал для получения сырых данных для обучения от клиентов.
    *   `ppo:weights:broadcast`: Канал для публикации обновленных весов модели, на который будут подписываться клиенты.

---

### Шаг 3: Реализация серверной логики

Фокусировка исключительно на процессе обучения и сохранения моделей.

1.  **Создать точку входа `src/server.ts`**:
    *   Этот файл будет инициализировать Ably-клиент и запускать основной модуль обучения.

2.  **Адаптировать логику обучения (`Learner`)**:
    *   Основной управляющий модуль (например, `LearnerManager`) должен подписаться на канал Ably `ppo:experience:submit`.
    *   При получении данных, они добавляются в `ReplayBuffer`.
    *   Существующая логика тренировки (`train.ts`, `LearnerPolicyWorker`, `LearnerValueWorker`) запускается, как и раньше, при наполнении буфера.

3.  **Реализовать публикацию и сохранение весов**:
    *   После каждого шага обучения, модуль сериализует новые веса модели.
    *   Веса публикуются в канал Ably `ppo:weights:broadcast`.
    *   Веса также сохраняются в локальную файловую систему (например, с помощью `model.save('file://./models/latest')`).

4.  **Адаптировать сохранение исторических моделей**:
    *   Найти существующую логику сохранения исторических моделей, которая использует `IndexedDB` (вероятно, в `src/Common/modelsCopy.ts`).
    *   **Не удалять эту логику.** Закомментировать ее или обернуть в проверку `if (false)`.
    *   Добавить комментарий `// TODO: Адаптировать для сохранения в файловую систему Node.js`, указывающий, что эту функциональность (сохранение снимка модели каждые 100,000 итераций) нужно будет реализовать для сервера на следующем этапе.

5.  **Удалить неиспользуемый код**:
    *   Полностью удалить весь код, связанный с симуляцией, генерацией опыта и управлением "акторами" (`ActorWorker`, `EpisodeManager`, `applyActionToTank` и т.д.).
    *   Удалить код, зависимый от браузерных API (`window`, `document`, UI-компоненты).

6.  **Адаптация под Node.js**:
    *   Изменить `src/Common/initTensorFlow.ts` для использования бэкенда `tfjs-node`.
    *   Адаптировать загрузку моделей (`src/Models/Trained/restore.ts`) для работы с локальной файловой системой.

---

### Шаг 4: Запуск и конфигурация

1.  **Скрипты `package.json`**:
    *   `"dev": "nodemon --watch 'src/**/*.ts' --exec 'ts-node' src/server.ts"`
    *   `"build": "tsc"`
    *   `"start": "node dist/server.js"`

2.  **Конфигурация**:
    *   Создать файл `.env` для хранения ключа API Ably. Добавить `.env` в `.gitignore`.
