# Задача: Миграция ml-backend на серверную архитектуру с Ably

Этот документ описывает шаги, необходимые для преобразования текущего клиентского приложения `ml-backend` в серверное приложение Node.js. Коммуникация между компонентами обучения и с внешними клиентами будет осуществляться через сервис реального времени Ably.

## Шаг 1: Настройка серверного окружения

Первым делом необходимо адаптировать проект для работы в среде Node.js.

1.  **Изменить `package.json`**:
    *   Удалить зависимости, специфичные для фронтенда: `vite`, `@vitejs/plugin-react`, `react`, `react-dom`, `tailwindcss`, `devtools-detect` и т.д.
    *   Добавить зависимости для Node.js: `ts-node`, `nodemon` для разработки.
    *   Заменить TensorFlow.js бэкенды: удалить `@tensorflow/tfjs-backend-wasm` и `@tensorflow/tfjs-backend-webgpu`, добавить `@tensorflow/tfjs-node` или `@tensorflow/tfjs-node-gpu`.
    *   Добавить SDK Ably: `ably`.
    *   Обновить секцию `"scripts"` для запуска и сборки Node.js приложения (например, ` "start": "ts-node src/server.ts" `).

2.  **Обновить `tsconfig.json`**:
    *   Изменить `target` на `ES2020` или новее.
    *   Изменить `module` на `NodeNext` или `CommonJS`.
    *   Изменить `moduleResolution` на `NodeNext` или `node`.
    *   Удалить `DOM` из `lib`, добавить `ESNext`.
    *   Удалить опции, связанные с Vite и React (`jsx`).

3.  **Удалить файлы конфигурации Vite**:
    *   Удалить `config.vite.ts`, `appo.html`.

## Шаг 2: Создание точки входа сервера

Нужно создать главный файл, который будет запускать все серверные процессы.

1.  **Создать `src/server.ts`**:
    *   Этот файл будет точкой входа в приложение.
    *   В нем будет происходить инициализация Ably.
    *   Он будет запускать основные компоненты, такие как `LearnerManager` и `Actor`'ы.

## Шаг 3: Рефакторинг кода под Node.js

Необходимо адаптировать существующую кодовую базу для работы на сервере.

1.  **Инициализация TensorFlow.js**:
    *   Изменить `src/Common/initTensorFlow.ts`, чтобы он устанавливал бэкенд `tfjs-node`: `tf.setBackend('tfjs-node');`.

2.  **Загрузка моделей**:
    *   Адаптировать `src/Models/Trained/restore.ts` для загрузки моделей из локальной файловой системы (`file://...`) вместо HTTP.

3.  **Удаление браузерного кода**:
    *   Удалить или заменить весь код, который зависит от браузерных API (`window`, `document`, `navigator`, `fetch` для локальных ресурсов).
    *   Удалить файлы, связанные с UI: `src/Common/uiUtils.ts`, `tfjs-vis`.
    *   Удалить `isDevtoolsOpen.ts`.

## Шаг 4: Интеграция Ably для внутренней коммуникации

Текущая система, вероятно, использует `BroadcastChannel` или `Web Workers` для связи между `Learner` и `Actor`. Эту логику нужно заменить на Ably.

1.  **Создать Ably-клиент**:
    *   В `src/server.ts` или в отдельном файле `src/ably.ts` создать и экспортировать инстанс Ably.

2.  **Определить каналы Ably**:
    *   Создать типизированный список каналов для внутренней коммуникации, например:
        *   `ppo:learner:weights` - для рассылки весов модели от `Learner` к `Actor`.
        *   `ppo:actor:trajectory` - для отправки траекторий от `Actor` к `Learner`.
        *   `ppo:learner:stats` - для отправки статистики обучения.

3.  **Заменить `postMessage` на `ably.channels.get(...).publish(...)`**:
    *   В `ActorWorker.ts` заменить отправку данных (`trajectory`) на публикацию в канал Ably.
    *   В `LearnerPolicyWorker.ts` и `LearnerValueWorker.ts` заменить получение данных на подписку на соответствующий канал Ably.
    *   В `LearnerManager` заменить рассылку весов на публикацию в канал Ably.

## Шаг 5: Проектирование API для внешних клиентов

Для взаимодействия с игровыми клиентами (например, `packages/tanks`) нужно определить публичный API через Ably.

1.  **Определить клиентские каналы Ably**:
    *   `client:[client_id]:actions` - для получения действий от конкретного клиента.
    *   `game:[game_id]:state` - для трансляции состояния игры всем клиентам в этой игре.
    *   `client:matchmaking` - для поиска игры.

2.  **Реализовать обработчики**:
    *   На сервере `ml-backend` подписаться на каналы действий клиентов.
    *   Полученные действия передавать в симуляцию (`Actor`).
    *   После каждого шага симуляции публиковать обновленное состояние игры в канал `game:[game_id]:state`.

## Шаг 6: Обновление логики запуска и развертывания

1.  **Обновить `package.json` скрипты**:
    *   `"dev": "nodemon --watch 'src/**/*.ts' --exec 'ts-node' src/server.ts"`
    *   `"build": "tsc"`
    *   `"start": "node dist/server.js"`

2.  **Создать `.env` файл**:
    *   Добавить `.env` для хранения ключа API Ably и других конфигурационных переменных. Добавить `.env` в `.gitignore`.

3.  **Dockerfile (Опционально)**:
    *   Создать `Dockerfile` для контейнеризации серверного приложения для упрощения развертывания.
